jQuery(document).ready(function(a){var b;"undefined"!=typeof bu&&"undefined"!=typeof bu.plugins.navigation&&"undefined"!=typeof bu.plugins.navigation.tree&&(b=bu.plugins.navigation);var c=a("#group-member-list"),d=a("a.nav-link");d.click(function(b){b.preventDefault();var c=a("a.nav-tab[href="+this.hash+"]"),d=a(this.hash);$input=a(d.hasClass("group-panel")?"#tab":"#perm_panel"),$input.val(c.data("target")),c.addClass("nav-tab-active").siblings().removeClass("nav-tab-active"),d.addClass("active").siblings().removeClass("active")});var e=60;a("#edit-group-name").blur(function(){var b=a.trim(a(this).val());return b.length>e&&(b=b.slice(0,e-1),a(this).val(b)),b.length<1?(E(buse_group_editor_settings.nameRequiredNotice),!1):(F(),void a("#group-stats-name").html(b))}),a(".member:not(.active)").appendTo("#inactive-members"),c.delegate("a.remove_member","click",function(b){b.preventDefault(),a(this).parent(".member").removeClass("active").slideUp("fast",function(){a(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked"),n()})});var f=function(){return a.map(a('li.member.active input[type="checkbox"]'),function(a){return parseInt(a.value,10)})},g=function(b,c){return a.grep(b,function(a){return c=c.toLowerCase(),a.user.is_section_editor&&(-1!=a.user.display_name.toLowerCase().indexOf(c)||-1!=a.user.login.toLowerCase().indexOf(c)||-1!=a.user.nicename.toLowerCase().indexOf(c)||-1!=a.user.email.toLowerCase().indexOf(c))})},h=function(b){return a.grep(b,function(a){return!i(a.user)})},i=function(b){var c=f();return a.inArray(b.id,c)>-1},j=function(b){var c=a.grep(buse_site_users,function(a){var c=b.toLowerCase();return a.user.display_name.toLowerCase()==c||a.user.login.toLowerCase()==c||a.user.nicename.toLowerCase()==c||a.user.email.toLowerCase()==c});return c.length>1||0==c.length?!1:c[0].user},k=a(".buse-suggest-user").autocomplete({source:function(b,c){var d=g(buse_site_users,b.term),d=h(d),e=a.map(d,function(a){return a.autocomplete});c(e)},delay:500,minLength:2,position:"undefined"!=typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){a(this).addClass("open")},close:function(){a(this).removeClass("open")}});a("#add_member").bind("click",function(a){a.preventDefault(),l()}),a("#user_login").keypress(function(a){"13"==a.keyCode&&(a.preventDefault(),l())});var l=function(){var b=a.trim(a("#user_login").val());if(b){k.autocomplete("search","");var c=j(b);if(c)if(c.is_section_editor)if(i(c)){var d="<b>"+c.display_name+"</b> "+a("<p/>").html(buse_group_editor_settings.userAlreadyMemberNotice).text();E(d,"members-message")}else F("members-message"),m(c);else{var d="<b>"+c.display_name+"</b> "+a("<p/>").html(buse_group_editor_settings.userWrongRoleNotice).text();E(d,"members-message")}else{var d="<b>"+b+"</b> "+a("<p/>").html(buse_group_editor_settings.userNotExistsNotice).text();E(d,"members-message")}}a("#user_login").val("").focus()},m=function(b){a("#member_"+b.id).attr("checked","checked").parent(".member").addClass("active").appendTo(c).slideDown("fast"),n()},n=function(){var b,d;b=c.children(".member").length,d=1==b?buse_group_editor_settings.memberCountSingularLabel:buse_group_editor_settings.memberCountPluralLabel,a(".member-count").html(b),a(".member-count-label").text(d)},o=function(c){var d=c.find(".perm-editor").first();d.hasClass("hierarchical")?"undefined"==typeof b?(alert(buse_group_editor_settings.navDepAlertText),d.html(buse_group_editor_settings.navDepEditorText)):w(d):u(d),r(c,d),d.delegate(".edit-perms","click",function(b){var c,e,f=a(b.currentTarget),g=f.closest("li"),h=f.attr("class");b.stopPropagation(),b.preventDefault(),h.indexOf("allowed")>-1?c="allowed":h.indexOf("denied")>-1&&(c="denied"),e="allowed"==c?!0:!1,z(g,e,d),d.trigger("perm_updated",[{post:g,action:c}])}),a(document).bind("click",function(b){var c=a(".perm-panel.active"),d=a(".perm-editor",c),e=a.contains(c[0],b.target);e||(d.hasClass("hierarchical")&&"undefined"!=typeof d.jstree?d.jstree("deselect_all"):d.find(".perm-item-selected").removeClass("perm-item-selected"))}),c.addClass("loaded")};a("#perm-tab-container").delegate("a","click",function(){var b=a(a(this).attr("href"));b.hasClass("loaded")||o(b)});var p,q,r=function(b,c){b.delegate("button.perm-search","click",function(b){b.preventDefault();var d=c.data("post-type"),e=a("#perm-search-"+d).val(),f={post_type:c.data("post-type"),query:{s:e}};x(c,f)}),b.find(".pagination-links").delegate("a","click",function(b){if(b.preventDefault(),!a(this).hasClass("disabled")){var d=a(this).attr("class"),e=parseInt(a(this).parent().find(".current-page").val()),f=parseInt(a(this).parent().find(".total-pages").text()),g=1;switch(d){case"first-page":g=1;break;case"prev-page":g=e-1;break;case"next-page":g=e+1;break;case"last-page":g=f}s(g,c)}}),b.delegate("input.current-page","keypress",function(b){if("13"==b.keyCode){b.preventDefault();var d=a(this).val(),e=parseInt(a(this).parent().find(".total-pages").text());1>d?a(this).val(1):d>e&&a(this).val(e),d=a(this).val(),s(d,c)}}),b.delegate("input.perm-search","keypress",function(b){13==b.keyCode&&(b.preventDefault(),a(this).siblings("button").first().click())}),b.delegate("a.perm-editor-bulk-edit","click",function(d){d.preventDefault();var e=a(this);b.hasClass("bulk-edit")?(e.removeClass("bulk-edit-close").attr("title",buse_group_editor_settings.bulkEditOpenTitle).text(buse_group_editor_settings.bulkEditOpenText),b.removeClass("bulk-edit")):(e.addClass("bulk-edit-close").attr("title",buse_group_editor_settings.bulkEditCloseTitle).text(buse_group_editor_settings.bulkEditCloseText),b.addClass("bulk-edit")),c.find(".perm-item-selected").removeClass("perm-item-selected"),b.find('input[type="checkbox"]').attr("checked",!1),a(".bulk-edit-actions select").val("none")}),b.delegate(".bulk-edit-select-all","click",function(){var a=c.find("li");a.children('input[type="checkbox"]').attr("checked",this.checked)}),b.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();var e=a(this).siblings("select"),f=e.val(),g=c.find('input[type="checkbox"]:checked');g.length>0&&("allowed"==f||"denied"==f)&&g.each(function(){var b=a(this).parents("li"),d="allowed"==f?!0:!1;z(b,d,c)}),b.find(".bulk-edit-select-all").attr("checked",!1),e.val("none"),g.attr("checked",!1)}),b.delegate("a.perm-tree-expand","click",function(b){b.preventDefault(),"undefined"!=typeof a.jstree&&a.jstree._reference(c).open_all()}),b.delegate("a.perm-tree-collapse","click",function(b){b.preventDefault(),"undefined"!=typeof a.jstree&&a.jstree._reference(c).close_all()})},s=function(b,c){var d=c.closest(".perm-panel"),e=c.data("post-type"),f={post_type:e,query:{paged:b}},g=a("#perm-search-"+e).val();g.length>0&&(f.query.s=g),d.find(".bulk-edit-select-all").attr("checked",!1),d.find(".bulk-edit-actions select").val("none"),x(c,f)},t=function(a){var b=a.hasClass("allowed")?"allowed":"denied",c="allowed"==b?"denied":"allowed",d="";d="allowed"==c?buse_group_editor_settings.permAllowLabel:buse_group_editor_settings.permDenyLabel,a.removeClass(b).addClass(c).text(d)},u=function(a){var b=a.data("post-type");v(a),a.bind("posts_loaded.buse",function(){var b,c,d,e=a.data("perm-edits")||{allowed:[],denied:[]};for(b=0;b<e.allowed.length;b+=1)c=e.allowed[b],d=a.find("#p"+c),d.length&&z(d,!0,a);for(b=0;b<e.denied.length;b+=1)c=e.denied[b],d=a.find("#p"+c),d.length&&z(d,!1,a)}),x(a,{post_type:b})},v=function(b){b.delegate("a","click",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).parent("li").first();c.siblings("li.perm-item-selected").each(function(){a(this).removeClass("perm-item-selected")}),c.addClass("perm-item-selected")}),b.bind("perm_updated",function(a,b){b.post.removeClass("perm-item-selected")})},w=function(c){var d={el:"#"+c.attr("id"),groupID:a("#group_id").val()||-1,postType:c.data("post-type")};a.extend(d,buse_perm_editor_settings),b.tree("buse_perm_editor",d),c.bind("load_node.jstree",function(a,b){-1!=b.rslt.obj&&B(b.rslt.obj)}).bind("perm_updated",function(a,b){var d=b.post;d.hasClass("jstree-closed")&&c.jstree("open_all",d),c.jstree("deselect_node",d)})},x=function(b,c){var d={action:"buse_render_post_list",group_id:a("#group_id").val()||-1,query:{}};void 0!==typeof c&&a.extend(d,c),b.addClass("loading"),d.query.offset?b.append('<li class="loader">'+buse_group_editor_settings.loadingText+"</li>"):b.html('<ul><li class="loader">'+buse_group_editor_settings.loadingText+"</li></ul>"),a.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(a){d.query.offset?b.append(a.posts):b.html(a.posts);var c={page:a.page,found_posts:a.found_posts,post_count:a.post_count,max_num_pages:a.max_num_pages};y(c,b),b.trigger("posts_loaded.buse",{posts:a.posts}),b.removeClass("loading")},error:function(){}})},y=function(b,c){{var d=c.data("post-type");a("#group_id").val()}if($pagination=a("#perm-editor-pagination-"+d),$total_items=$pagination.find(".displaying-num"),$current_page=$pagination.find(".current-page"),$total_pages=$pagination.find(".total-pages"),$first_page=$pagination.find(".first-page"),$prev_page=$pagination.find(".prev-page"),$next_page=$pagination.find(".next-page"),$last_page=$pagination.find(".last-page"),b.max_num_pages>1){var e=1==parseInt(b.found_posts)?" item":" items";$total_items.text(b.found_posts+e),$current_page.val(b.page),$total_pages.text(b.max_num_pages),1==b.page?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),$prev_page.removeClass("disabled")),b.page==b.max_num_pages?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled")),$pagination.show()}else $pagination.hide()},z=function(a,b,c){var d,e=c.data("post-type"),f=c.data("perm-edits")||{allowed:[],denied:[]};A(a,b,f),c.hasClass("hierarchical")&&(d=a.parent("ul").parent("div").attr("id")!=c.attr("id")?a.parents("li:last"):a,B(d)),c.data("perm-edits",f),D(e)},A=function(b,c,d){var e=b.attr("id").substr(1),f=b.find(".edit-perms").first();c!=b.data("editable")&&t(f);var g,h=c?"allowed":"denied",i=b.data("editable-original");b.data("editable",c),b.attr("rel",h),i!=c?(g=a.inArray(e,d[h]),-1===g&&d[h].push(e)):(g=a.inArray(e,d.allowed),g>-1&&d.allowed.splice(g,1),g=a.inArray(e,d.denied),g>-1&&d.denied.splice(g,1));var j=b.find("> ul > li");j.each(function(){A(a(this),c,d)})},B=function(b){$sections=b.find("ul"),$sections.each(function(){var b=a(this).parents("li").first();if(b.length){var c=b.attr("rel"),d=!1;switch(c){case"allowed":case"allowed-desc-denied":case"allowed-desc-unknown":d=a(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length,d?b.attr("rel","allowed-desc-denied"):b.attr("rel","allowed"),C(b,d);break;case"denied":case"denied-desc-allowed":case"denied-desc-unknown":d=a(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length,d?b.attr("rel","denied-desc-allowed"):b.attr("rel","denied"),C(b,d)}}})},C=function(b,c){var d=b.find("> a > .perm-stats"),e=b.data("editable");0===d.length&&(d=a(' <span class="perm-stats"><ins class="jstree-icon">&nbsp;</ins><span class="label"></span></span>'),b.find("> a > .title-count").after(d)),d.removeClass("allowed denied").children(".label").text(""),c&&(e?d.addClass("denied").children(".label").text(c+" "+buse_group_editor_settings.permNonEditableLabel):d.addClass("allowed").children(".label").text(c+" "+buse_group_editor_settings.permEditableLabel))},D=function(b){var c=a("#"+b+"-stats"),d=a(".perm-stats-diff",c),e=a("#perm-editor-"+b).data("perm-edits");0===d.length&&(d=a('<span class="perm-stats-diff"></span>'),c.append(d));var f,g,h=[];for(f in e)e[f].length&&(g="allowed"===f?"+":"-",h.push('<span class="'+f+'">'+g+e[f].length+"</span>"));var i=h.join(", ");d.html(i?" ("+i+")":"")},E=function(b,c,d){var e={classes:"error",before_msg:"<p>",after_msg:"</p>"};d&&"object"==typeof d&&a.extend(e,d);var f=c||"message",g=a("#"+f);g.attr("class",e.classes).html(e.before_msg+b+e.after_msg).fadeIn()},F=function(b){var c=b||"message";a("#"+c).fadeOut("fast",function(){a(this).attr("class","").html("")})};p=a("#edit-group-name").val();var G=function(){var b=[];return a("#group-member-list").children("li.member.active").each(function(c,d){b.push(a(d).children("input").first().val())}),b};q=G(),window.onbeforeunload=function(){return H()?buse_group_editor_settings.dirtyLeaverNotice:void 0};var H=function(){var b,c,d,e,f=!1;if(b=a("#edit-group-name").val(),p!=b&&(f=!0),c=G(),q.length!=c.length)f=!0;else for(e=0;e<q.length;e+=1)-1==a.inArray(q[e],c)&&(f=!0);return a(".perm-editor").each(function(){d=a(this).data("perm-edits"),"undefined"!=typeof d&&(d.allowed.length||d.denied.length)&&(f=!0)}),f};if(a("#group-edit-form").submit(function(){window.onbeforeunload=null;var b=a.trim(a("#edit-group-name").val());return b.length<1?(E(buse_group_editor_settings.nameRequiredNotice),!1):void a(".perm-editor").each(function(){var b=a(this).data("perm-edits")||{allowed:[],denied:[]};a(this).siblings(".buse-edits").val(JSON.stringify(b))})}),a("a.submitdelete").click(function(b){b.preventDefault();var c=buse_group_editor_settings.deleteGroupNotice+"\n\n"+buse_group_editor_settings.confirmActionNotice;confirm(c)&&(window.onbeforeunload=null,window.location=a(this).attr("href"))}),document.images){var I=new Image,J=new Image;I.src=buse_group_editor_settings.pluginUrl+"/images/group_perms_sprite.png",J.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}var K=a("#perm-panel-container").find(".perm-panel.active").first();K.length&&o(K),a("div#message").insertAfter(a("div.wrap h2:first"))});